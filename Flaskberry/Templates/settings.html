<!DOCTYPE html>
<html>
    <head>
     <meta charset="UTF-8">
 	<title>Settings</title>
    </head>
<style>
nav {
    text-align: center;
    margin: auto;
}
table {
    text-align: center;
    margin: auto;
}
div {
    text-align: center;
    margin: auto;
    background-color: 	#525564;
    color:	#FEF6EB;
    width: 650px;
}
button{
     background-color: #4CAF50; /* Green */
    border: none;
    color: white;
    padding: 5px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    cursor: pointer;
    border-radius: 12px;
}
h3 {
    text-align: center;
    margin: auto;
    color: 	#525564;
}
.add{
    float: right;
    }
.delete{
    background-color: #f44336;
    }
.save{
   color: white;
    }
.tooLong{
    width:80%;
    }
.savebutton{
    text-align: center;
    margin: auto;
    }
</style>
<body>
 <nav>
<h3>
<a href="/">Home</a> 
<a href="/temperature">Temperature</a> |
<a href="/distance">Distance</a> |
<a href="/help">Help</a> |
<a href="/about">About</a>
</h3>
</nav>
    <hr>
    <h3>Temperature settings</h3>
    <div>
    <form id='T' method="post">
        <table id='temperatureTable'>
           <tr> <th>Bus name</th><th>Name</th><tr>
        {% for item in keys%}
        <tr><td>{{item}}</td><td><input id ={{item}} type="text" name={{item}}><td></tr>
        {% endfor %}
        </table> 
	</form>
    </div>
    <br><br>
    <h3>LED settings</h3>
    <div>
    <form id='LED' method="post">
        <table id='ledTable'>
        <tr>
    <th>Name </th>
    <th>Pin </th>
      </tr>
        </table> 
    <button class="add" type="button" onclick="add();"><h3 class="save"> + </h3></button>
	</form>
    </div>
    <br><br>
    <h3>Ultrasound settings</h3>
    <div>
    <form id='US' method="post">
        <table id='ultraSoundTable'>
        <tr>
    <th>Name </th>
    <th>Echo </th>
    <th>Trigger</th>
      </tr>
        </table> 
    <button class="add" type="button" onclick="add2();"><h3 class="save"> + </h3></button>
	</form>
    </div>
    <br><br>
    <h3 class="save"><button class="savebutton" type="button"value="Submit" onclick="sendData()">Save</button></h3>
<script>
/*
these javascript code is here because I had problem to setup SSE in flask
*/
var ledTable = document.getElementById("ledTable");
var ultraSoundTable = document.getElementById("ultraSoundTable");
var data_ = JSON.parse('{{settingsData}}'.split("&#34;").join('"'))
var keys = Object.keys(data_);
var temperatureSensors = keys.filter(key => key.includes('28'));
for (var i = 0; i < temperatureSensors.length; i++) {
    // Iterate over numeric indexes from 0 to 5, as everyone expects.
    var key = temperatureSensors[i];
    var inputName = document.getElementById(key);
    inputName.setAttribute('value',data_[key])
}
var ultraSoundSensors = keys.filter(key => key.includes('Ultra'));
var USlength = ultraSoundSensors.length/3;
for (var i = 0; i< USlength; i++){
    var ind = i;
    var indie = ind + 1;
    var rows = "ultraSoundTable" + ind;
    var tr = document.createElement("TR");
    tr.setAttribute("id", rows);
    var t = document.createElement("INPUT");
    t.setAttribute("type", "text");
    t.setAttribute("class", "tooLong");
    t.setAttribute("name", "UltraSoundName_" + indie+'_');
    t.setAttribute("value", data_["UltraSoundName_" + indie +'_']);
    var x = document.createElement("INPUT");
    x.setAttribute("type", "text");
    x.setAttribute("class", "tooLong")
    x.setAttribute("name", "UltraSoundEcho_" + indie +'_');
    x.setAttribute("value", data_["UltraSoundEcho_" + indie+'_']);
    var y = document.createElement("INPUT");
    y.setAttribute("type", "text");
    y.setAttribute("class", "tooLong")
    y.setAttribute("name", "UltraSoundTrigger_" + indie +'_');
    y.setAttribute("value", data_["UltraSoundTrigger_" + indie +'_']);
    var z = document.createElement("BUTTON");
    z.innerHTML = 'Delete';
    z.setAttribute("class", "delete");
    z.setAttribute("type", "button");
    z.setAttribute("value", rows);
    // add delete function to button on the right side
    z.onclick = function() { 
        var row = document.getElementById(this.value);
        row.parentNode.removeChild(row);}; 
    var tTD = document.createElement("TD");
    var xTD = document.createElement("TD");
    var yTD = document.createElement("TD");
    var zTD = document.createElement("TD");
    tTD.appendChild(t)
    xTD.appendChild(x)
    yTD.appendChild(y)
    zTD.appendChild(z)
    tr.appendChild(tTD)
    tr.appendChild(xTD)
    tr.appendChild(yTD)
    tr.appendChild(zTD)
    ultraSoundTable.appendChild(tr);
}
var LedSensors = keys.filter(key => key.includes('Led'));
var Ledlength = LedSensors.length/2;
for (var i = 0; i< Ledlength; i++){
    var ind = i;
    var indie = ind + 1;
    var rows = "ledTable" + ind;
    var tr = document.createElement("TR");
    tr.setAttribute("id", rows);
    var x = document.createElement("INPUT");
    x.setAttribute("type", "text");
    x.setAttribute("name", "LedName_" + indie +'_');
    x.setAttribute("value", data_["LedName_" + indie +'_']);
    var y = document.createElement("INPUT");
    y.setAttribute("type", "text");
    y.setAttribute("name", "LedPin_" + indie + '_');
    y.setAttribute("value", data_["LedPin_" + indie +'_']);
    var z = document.createElement("BUTTON");
    z.innerHTML = 'Delete';
    z.setAttribute("class", "delete");
    z.setAttribute("type", "button");
    z.setAttribute("value", rows);
    // add delete function to button on the right side
    z.onclick = function() { 
        var row = document.getElementById(this.value);
        row.parentNode.removeChild(row);}; 
    var xTD = document.createElement("TD");
    var yTD = document.createElement("TD");
    var zTD = document.createElement("TD");
    xTD.appendChild(x)
    yTD.appendChild(y)
    zTD.appendChild(z)
    tr.appendChild(xTD)
    tr.appendChild(yTD)
    tr.appendChild(zTD)
    ledTable.appendChild(tr);
}
    
function add() {
    // ledTable is added to have unique ids
    var ind = ledTable.rows.length;
    var rows = "ledTable" + ultraSoundTable.rows.length;
    var tr = document.createElement("TR");
    tr.setAttribute("id", rows);
    var x = document.createElement("INPUT");
    x.setAttribute("type", "text");
    x.setAttribute("name", "LedName_" + ind + '_');
    var y = document.createElement("INPUT");
    y.setAttribute("type", "text");
    y.setAttribute("name", "LedPin_" + ind + '_');
    var z = document.createElement("BUTTON");
    z.innerHTML = 'Delete';
    z.setAttribute("class", "delete");
    z.setAttribute("type", "button");
    z.setAttribute("value", rows);
    // add delete function to button on the right side
    z.onclick = function() { 
        var row = document.getElementById(this.value);
        row.parentNode.removeChild(row);}; 
    var xTD = document.createElement("TD");
    var yTD = document.createElement("TD");
    var zTD = document.createElement("TD");
    xTD.appendChild(x)
    yTD.appendChild(y)
    zTD.appendChild(z)
    tr.appendChild(xTD)
    tr.appendChild(yTD)
    tr.appendChild(zTD)
    ledTable.appendChild(tr);
}
function add2() {
    // ultraSoundTable is added to have unique ids
    var ind = ultraSoundTable.rows.length;
    var rows = "ultraSoundTable" + ultraSoundTable.rows.length;
    var tr = document.createElement("TR");
    tr.setAttribute("id", rows);
    var t = document.createElement("INPUT");
    t.setAttribute("type", "text");
    t.setAttribute("class", "tooLong");
    t.setAttribute("name", "UltraSoundName_" + ind + '_');
    var x = document.createElement("INPUT");
    x.setAttribute("type", "text");
    x.setAttribute("class", "tooLong")
    x.setAttribute("name", "UltraSoundEcho_" + ind + '_');
    var y = document.createElement("INPUT");
    y.setAttribute("type", "text");
    y.setAttribute("class", "tooLong")
    y.setAttribute("name", "UltraSoundTrigger_" + ind + '_');
    var z = document.createElement("BUTTON");
    z.innerHTML = 'Delete';
    z.setAttribute("class", "delete");
    z.setAttribute("type", "button");
    z.setAttribute("value", rows);
    // add delete function to button on the right side
    z.onclick = function() { 
        var row = document.getElementById(this.value);
        row.parentNode.removeChild(row);}; 
    var tTD = document.createElement("TD");
    var xTD = document.createElement("TD");
    var yTD = document.createElement("TD");
    var zTD = document.createElement("TD");
    tTD.appendChild(t)
    xTD.appendChild(x)
    yTD.appendChild(y)
    zTD.appendChild(z)
    tr.appendChild(tTD)
    tr.appendChild(xTD)
    tr.appendChild(yTD)
    tr.appendChild(zTD)
    ultraSoundTable.appendChild(tr);
}
function submitForms(){
    var data = {};
    var formDataT = new FormData(document.forms.T);
    for(var pair of formDataT.entries()) {
    data[pair[0]] = pair[1] 
    }
    var formDataUS = new FormData(document.forms.US);
    for(var pair of formDataUS.entries()) {
      data[pair[0]] = pair[1]  
    }
    var formDataLED = new FormData(document.forms.LED);
    for(var pair of formDataLED.entries()) {
       data[pair[0]] = pair[1] 
    }
    console.log(data)
    return data;
}

function sendData(){
    var data = submitForms();
    console.log(data)
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/sensor/settings', true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function() {//Call a function when the state changes.
    if(this.readyState == XMLHttpRequest.DONE && this.status == 200) {
        alert('Your settings have been saved. Please restart Controlberry')
    }
}
    var jsonData = JSON.stringify(data)
    xhr.send(jsonData);
}
/*
var keys = Object.keys(data)
var ultraSound = keys.filter(key => key.includes('Ultra'));
var temperatureSensors = keys.filter(key => key.includes('28'));
*/
</script>
</body>
</html>